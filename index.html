<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ICR with Camera Flip</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; background-color: #f9f9f9; }
        video, canvas { width: 100%; max-width: 500px; margin: 10px auto; border: 2px solid #00796b; border-radius: 10px; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px; border: none; background-color: #00796b; color: #fff; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #004d40; }
        h3 { text-decoration: underline; margin-top: 20px; }
        #outputAttributes { text-align: left; margin: 20px auto; width: 90%; max-width: 500px; }
        p { margin: 5px 0; }
        strong { color: #00796b; }
    </style>
</head>
<body>
    <h1>Mobile ICR with Camera Flip</h1>

    <!-- Camera Feed -->
    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <!-- Buttons -->
    <button id="flipButton">Flip Camera</button>
    <button id="captureButton">Capture Image</button>
    <button id="exportButton">Export to Excel</button>

    <!-- Output -->
    <h3>Extracted Data</h3>
    <div id="outputAttributes">No data yet...</div>

    <script>
        const keywords = [
            "Product name", "Colour", "Motor type", "Frequency", "Gross weight", "Ratio",
            "Motor Frame", "Model", "Speed", "Quantity", "Voltage", "Material", "Type",
            "Horse power", "Consinee", "LOT", "Stage", "Outlet", "Serial number", "Head Size",
            "Delivery size", "Phase", "Size", "MRP", "Use before", "Height",
            "Maximum Discharge Flow", "Discharge Range", "Assembled by", "Manufacture date",
            "Company name", "Customer care number", "Seller Address", "Seller email", "GSTIN",
            "Total amount", "Payment status", "Payment method", "Invoice date"
        ];

        let currentFacingMode = "environment"; // Start with back camera
        let stream = null;
        let extractedData = {};
        let allData = [];

        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const outputDiv = document.getElementById('outputAttributes');

        // Start Camera
        async function startCamera() {
            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: 1280, height: 720 }
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Camera access denied or unavailable.");
                console.error(err);
            }
        }

        // Flip Camera
        document.getElementById('flipButton').addEventListener('click', () => {
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            startCamera();
        });

        // Capture Image
        document.getElementById('captureButton').addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const img = new Image();
                img.src = URL.createObjectURL(blob);
                img.onload = () => processImage(img);
            }, 'image/png', 1.0); // High-quality image
        });

        // Process Image with Tesseract.js
        async function processImage(img) {
            outputDiv.innerHTML = "<p>Processing...</p>";
            const result = await Tesseract.recognize(img, 'eng', { logger: m => console.log(m) });
            console.log("Extracted Text:", result.data.text);
            processTextToAttributes(result.data.text);
        }

        // Map Extracted Text to Keywords
        function processTextToAttributes(text) {
            const lines = text.split("\n");
            extractedData = {};

            keywords.forEach(keyword => {
                let found = false;
                for (let line of lines) {
                    if (line.includes(keyword)) {
                        extractedData[keyword] = line.split(":")[1]?.trim() || "-";
                        found = true;
                        break;
                    }
                }
                if (!found) extractedData[keyword] = "-";
            });

            allData.push(extractedData); // Append new data
            displayData();
        }

        // Display Extracted Data
        function displayData() {
            outputDiv.innerHTML = "";
            Object.entries(extractedData).forEach(([key, value]) => {
                outputDiv.innerHTML += `<p><strong>${key}:</strong> ${value}</p>`;
            });
        }

        // Export Data to Excel
        document.getElementById('exportButton').addEventListener('click', () => {
            const workbook = XLSX.utils.book_new();
            const headers = keywords;
            const data = allData.map(row => headers.map(key => row[key] || "-"));
            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);

            XLSX.utils.book_append_sheet(workbook, worksheet, "Extracted Data");
            XLSX.writeFile(workbook, "Mobile_ICR_Data.xlsx");
        });

        // Start Camera on Load
        startCamera();
    </script>
</body>
</html>
